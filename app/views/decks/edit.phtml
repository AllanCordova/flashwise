<main class="deck-edit-container">
    <div class="deck-edit-wrapper">
        <!-- Header -->
        <div class="deck-edit-header">
            <h1><i class="bi bi-pencil"></i> Editar Deck</h1>
            <a href="/decks?page=<?= $returnPage ?? 1 ?>&sort=<?= urlencode($returnSort ?? 'created_desc') ?>" class="btn-back">
                <i class="bi bi-arrow-left"></i> Voltar para Decks
            </a>
        </div>

        <!-- Formulário de Edição do Deck -->
        <div class="deck-form-section">
            <h2><i class="bi bi-collection"></i> Informações do Deck</h2>
            <form id='deck_update' action="<?= route('decks.update', ['id' => $deck->id]) ?>" method="post" class="deck-form <?= $deck->hasErrors() ? 'was-validated' : '' ?>" novalidate>
                <input type="hidden" name="_method" value="PUT">
                <input type="hidden" name="page" value="<?= $returnPage ?? 1 ?>">
                <input type="hidden" name="sort" value="<?= htmlspecialchars($returnSort ?? 'created_desc') ?>">

                <div class="form-group">
                    <label for="name">
                        <i class="bi bi-tag"></i> Nome do Deck
                    </label>
                    <input
                        type="text"
                        id="name"
                        name="deck[name]"
                        class="form-control <?= ($deck->hasErrors() && $deck->errors('name')) ? 'is-invalid' : '' ?>"
                        value="<?= htmlspecialchars($deck->name ?? '') ?>"
                        placeholder="Digite o nome do deck"
                        required>
                    <?php if ($deck->errors('name')): ?>
                        <div class="invalid-feedback" style="display: block !important;"><?= $deck->errors('name') ?></div>
                    <?php endif; ?>
                </div>

                <div class="form-group">
                    <label for="description">
                        <i class="bi bi-text-left"></i> Descrição
                    </label>
                    <textarea
                        id="description"
                        name="deck[description]"
                        class="form-control <?= ($deck->hasErrors() && $deck->errors('description')) ? 'is-invalid' : '' ?>"
                        rows="3"
                        placeholder="Descreva o conteúdo deste deck"
                        required><?= htmlspecialchars($deck->description ?? '') ?></textarea>
                    <?php if ($deck->errors('description')): ?>
                        <div class="invalid-feedback" style="display: block !important;"><?= $deck->errors('description') ?></div>
                    <?php endif; ?>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-check-circle"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Cards -->
        <div class="cards-section">
            <div class="cards-header">
                <h2><i class="bi bi-card-list"></i> Cards deste Deck</h2>
                <a href="<?= route('cards.new') ?>?deck_id=<?= $deck->id ?>&return_deck_id=<?= $deck->id ?>&page=<?= $returnPage ?? 1 ?>&sort=<?= urlencode($returnSort ?? 'created_desc') ?>" class="btn-add-card">
                    <i class="bi bi-plus-circle"></i> Novo Card
                </a>
            </div>

            <?php if (empty($cards)): ?>
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>Nenhum card neste deck</h3>
                    <p>Comece adicionando o primeiro flashcard!</p>
                    <a href="<?= route('cards.new') ?>?deck_id=<?= $deck->id ?>&return_deck_id=<?= $deck->id ?>&page=<?= $returnPage ?? 1 ?>&sort=<?= urlencode($returnSort ?? 'created_desc') ?>" class="btn-primary">
                        <i class="bi bi-plus-circle fs-5"></i> Criar Primeiro Card
                    </a>
                </div>
            <?php else: ?>
                <div class="cards-table-wrapper">
                    <table class="cards-table">
                        <thead>
                            <tr>
                                <th><i class="bi bi-question-circle"></i> Frente</th>
                                <th><i class="bi bi-lightbulb"></i> Verso</th>
                                <th><i class="bi bi-tag"></i> Status</th>
                                <th><i class="bi bi-gear"></i> Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($cards as $card): ?>
                                <tr>
                                    <td class="card-front" data-label="Frente">
                                        <div class="card-content">
                                            <?= htmlspecialchars(mb_substr($card->front, 0, 60)) ?>
                                            <?= mb_strlen($card->front) > 60 ? '...' : '' ?>
                                        </div>
                                    </td>
                                    <td class="card-back" data-label="Verso">
                                        <div class="card-content">
                                            <?= htmlspecialchars(mb_substr($card->back, 0, 60)) ?>
                                            <?= mb_strlen($card->back) > 60 ? '...' : '' ?>
                                        </div>
                                    </td>
                                    <td class="card-status" data-label="Status">
                                        <div class="status-container">
                                            <?php if ($card->isNew()): ?>
                                                <span class="badge badge-new">
                                                    <i class="bi bi-star"></i> Novo
                                                </span>
                                            <?php elseif ($card->isDue()): ?>
                                                <span class="badge badge-due">
                                                    <i class="bi bi-clock"></i> Revisar
                                                </span>
                                            <?php else: ?>
                                                <span class="badge badge-learned">
                                                    <i class="bi bi-check-circle"></i> Aprendido
                                                </span>
                                                <?php 
                                                $timeDetails = $card->getDetailedTimeUntilReview();
                                                if ($timeDetails): 
                                                ?>
                                                    <span class="time-countdown">
                                                        <i class="bi bi-hourglass-split"></i>
                                                        <?php if ($timeDetails['days'] > 0): ?>
                                                            <?= $timeDetails['days'] ?>d 
                                                        <?php endif; ?>
                                                        <?php if ($timeDetails['hours'] > 0 || $timeDetails['days'] > 0): ?>
                                                            <?= str_pad($timeDetails['hours'], 2, '0', STR_PAD_LEFT) ?>h 
                                                        <?php endif; ?>
                                                        <?php if ($timeDetails['days'] == 0): ?>
                                                            <?= str_pad($timeDetails['minutes'], 2, '0', STR_PAD_LEFT) ?>m
                                                        <?php endif; ?>
                                                    </span>
                                                <?php endif; ?>
                                            <?php endif; ?>
                                        </div>
                                    </td>
                                    <td class="card-actions">
                                        <a href="<?= route('cards.edit', ['id' => $card->id]) ?>?return_deck_id=<?= $deck->id ?>&page=<?= $returnPage ?? 1 ?>"
                                            class="btn-action btn-edit"
                                            title="Editar card">
                                            <i class="bi bi-pencil"></i>
                                        </a>

                                        <!-- formulario de exclusão do card -->
                                        <form action="<?= route('cards.destroy', ['id' => $card->id]) ?>"
                                            method="post"
                                            class="delete-form"
                                            onsubmit="return confirm('Tem certeza que deseja excluir este card?');">
                                            <input type="hidden" name="_method" value="DELETE">
                                            <input type="hidden" name="page" value="<?= $returnPage ?? 1 ?>">
                                            <button type="submit"
                                                class="btn-action btn-delete"
                                                title="Excluir card">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>

                <div class="cards-summary">
                    <div class="summary-item">
                        <i class="bi bi-collection"></i>
                        <span><strong><?= count($cards) ?></strong> card(s) no total</span>
                    </div>
                    <div class="summary-item">
                        <i class="bi bi-star"></i>
                        <span><strong><?= $deck->countNewCards() ?></strong> novo(s)</span>
                    </div>
                    <div class="summary-item">
                        <i class="bi bi-clock"></i>
                        <span><strong><?= $deck->countDueCards() ?></strong> para revisar</span>
                    </div>
                </div>
            <?php endif; ?>
        </div>
    </div>
</main>